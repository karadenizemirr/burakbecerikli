<div class="row d-flex justify-content-center mt-5">
    <div class="card shadow p-3 text-center" id="responsiveDiv">
        <div class="card-title">
            <h1>
                Arama Yap
            </h1>
            <p class="primary-color" style="font-size: 12px;" >
                Bu işlem zaman alabilir. Sayfadan ayrılsanız bile işleminiz devam edecektir. 
                Verilerinizi görüntülemek için veri sayfanızı ziyaret edin.
            </p>
        </div>
        <div class="card-body">
            <form id="search_form">
                <div class="form-group mb-3">
                    <input type="text" id="input-tags" name="keywords" placeholder="Aranacak Kelimeler" />
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <select name="city" id="" class="form-control">
                            <option value="all">Tüm Şehirler</option>
                            {{#each data}}
                            <option value="{{this.il_adi}}">{{this.il_adi}}</option>
                            {{/each}}
                        </select>
                    </div>
                    <div class="col">
                        <select name="district" id="" class="form-control">
                            <option value="">Tüm İlçeler</option>
                        </select>
                    </div>
                </div>
                <div class="form-group mb-3">
                    <button class="btn custom-button" id="search_button" type="submit">
                        Arama Başlat
                    </button>
                    <div class="spinner-border" role="status" >
                        <span class="visually-hidden">Yüklemiyor...</span>
                    </div>
                </div>
                <div class="progress" role="progressbar" aria-label="Warning example" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" id="search_status">
                    <div class="progress-bar text-bg-warning" style="width: 0%" id="search_progress">0%</div>
                </div>

            </form>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        $('.spinner-border').hide()
        $("#input-tags").selectize({
            delimiter: ",",
            persist: false,
            create: function (input) {
                return {
                    value: input,
                    text: input,
                };
            },
        });
        $.ajax({
            url: '/search/countryData',
            method: 'GET',
            dataType: 'json',
            success: function (response) {
                var data = response.data
                $('select[name="city"]').change(function () {
                    var selectedCity = $(this).val();


                    if (selectedCity === 'all') {
                        $('select[name="district"]').html('<option value="all">Tüm İlçeler</option>');
                    } else {
                        var districtOptions = ''
                        districtOptions += '<option value="all">Tüm İlçeler</option>';
                        for (const d of data) {
                            if (selectedCity === d.il_adi) {
                                for (const a of d.ilceler) {
                                    districtOptions += `<option value="${a.ilce_adi}">${a.ilce_adi}</option>`
                                }
                            }
                        }

                        $('select[name="district"]').html(districtOptions);
                    }
                });
            }
        })

        // Post Operations

        $('#search_form').submit(function (e) {
            e.preventDefault();

            $('#search_button').hide()
            $('.spinner-border').show()
            var formData = $(this).serialize()
            var progressBar = $('#search_status')
            var searchProgress = $('#search_progress')
            $.ajax({
                url: '/search',
                method: 'POST',
                data: formData,
                xhr: function () {
                    var xhr = new window.XMLHttpRequest()
                    xhr.addEventListener('progress', function (evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = evt.loaded / evt.total * 100;
                            searchProgress.css('width', percentComplete + '%');
                            search_progress.text(percentComplete + '%');
                            progressBar.text(percentComplete + '%')
                            progressBar.attr('aria-valuenow', percentComplete);
                        }
                    }, false)
                    return xhr;

                },
                success: function (response) {
                    $('#search_button').show()
                    $('.spinner-border').hide()
                },
                error: function (xhr, status, error) {
                    console.log(xhr);
                },

                error: function (xhr, status, error) {
                    console.log('Country data error')
                },
                complete: function () {
                    $('#search_form')[0].reset()
                }

            })
        })

    });
</script>